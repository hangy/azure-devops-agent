name: ci-bake

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 3'
  workflow_dispatch:
    inputs:
      trivy_scan:
        description: 'Run Trivy vulnerability scan (true/false)'
        required: false
        default: 'false'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TRIVY_SCAN: ${{ github.event.inputs.trivy_scan || 'false' }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Free up runner disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: Log in to the Container registry
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build all targets with bake (non-main local build only)
        if: github.ref != 'refs/heads/main'
        uses: docker/bake-action@v6
        with:
          source: .
          files: docker-bake.hcl

      - name: Build all targets with bake (main - push to GHCR by digest)
        if: github.ref == 'refs/heads/main'
        id: bake
        uses: docker/bake-action@v6
        env:
          PUSH_GHCR: true
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        with:
          source: .
          files: docker-bake.hcl
          push: true

      - name: Inspect pushed images
        if: github.ref == 'refs/heads/main'
        run: |
          for TARGET in dotnet java android flutter; do
            echo "=== ${TARGET} ==="
            docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${TARGET}
          done

      - name: Install Trivy
        if: github.ref == 'refs/heads/main' && env.TRIVY_SCAN == 'true'
        run: |
          TRIVY_VERSION=0.54.1
          curl -fsSL https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz -o trivy.tar.gz
          tar -xzf trivy.tar.gz trivy
          sudo mv trivy /usr/local/bin/
          trivy --version

      - name: Vulnerability scan (fail on HIGH/CRITICAL)
        if: github.ref == 'refs/heads/main' && env.TRIVY_SCAN == 'true'
        run: |
          set -euo pipefail
          FAILED=0
          for TARGET in dotnet java android flutter; do
            REF=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${TARGET}
            echo "Scanning $REF"
            trivy image --scanners vuln --exit-code 1 --severity HIGH,CRITICAL --ignore-unfixed --timeout 10m "$REF" || FAILED=1
          done
          if [ $FAILED -ne 0 ]; then
            echo "Vulnerability threshold exceeded (HIGH/CRITICAL). Failing build before signing." >&2
            exit 1
          fi

      - name: Install Cosign
        if: github.ref == 'refs/heads/main'
        run: |
          COSIGN_VERSION=v2.2.4
          curl -fsSL "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64" -o cosign
          chmod +x cosign
          sudo mv cosign /usr/local/bin/
          cosign version

      - name: Sign images and attestations (keyless)
        if: github.ref == 'refs/heads/main'
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          for TARGET in dotnet java android flutter; do
            REF=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${TARGET}
            DIGEST=$(docker buildx imagetools inspect "$REF" --format '{{json .Manifest.Digest}}' | tr -d '"')
            echo "Signing $REF@$DIGEST"
            cosign sign "$REF@$DIGEST" --yes
            echo "Verifying provenance attestation exists for $REF"
            cosign verify-attestation "$REF@$DIGEST" --type=provenance || true
          done

      - name: Extract SBOMs via imagetools inspect (SPDX)
        if: github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          mkdir -p sbom
          for TARGET in dotnet java android flutter; do
            REF=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${TARGET}
            OUT=sbom/${TARGET}-sbom.json
            echo "Extracting SBOM for $REF"
            docker buildx imagetools inspect "$REF" --format '{{ json .SBOM.SPDX }}' > "$OUT" || {
              echo "No SPDX SBOM data available for $REF" >&2
              rm -f "$OUT"
              continue
            }
            echo "SBOM written to $OUT"
          done

      - name: Verify SBOM attestations (keyless)
        if: github.ref == 'refs/heads/main'
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          set -euo pipefail
          for TARGET in dotnet java android flutter; do
            REF=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${TARGET}
            echo "Verifying SBOM attestation for $REF (SPDX)"
            cosign verify-attestation "$REF" --type=spdx || echo "Warning: SBOM attestation verification failed for $REF" >&2
          done

      - name: Submit dependencies to GitHub Dependency Graph
        if: github.ref == 'refs/heads/main'
        uses: advanced-security/spdx-dependency-submission-action@v0.1.1
        with:
          filePath: "sbom/"
          filePattern: "*-sbom.json"

      - name: Upload SBOM artifacts
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v5
        with:
          name: sbom
          path: sbom/
          retention-days: 14
